<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Hypergeometric</title><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#eee;
background-color:#111;
padding:0 10px
}
textarea, input, button {
color:#eee;
background-color:#111;
}
button:hover {
  background-color:#222;
}
label {
  margin-left: 0.5em;
  margin-right: 1em;
}
</style>
  <script type="text/javascript" src="vis-graph3d.min.js"></script>
  <script type="text/javascript" src="hypergeometric.js"></script>
</head>

<body>
  <div id="root"></div>
</body>

<script type="text/javascript">
  const root = document.getElementById("root");

  const tempGlobal = {
    // graph stuff
    data: null,
    graph: null,
    // table stuff
    tableContainer: null
  };

  /** @type {(s: string, n: number) => string} */
  const repeatString = (s, n) => {
    let output = "";

    for (let i = 0; i < n; i += 1) {
      output += s;
    }

    return output
  }

  const PROB_ZERO = "0." + repeatString("0", Hypergeometric.PMF_DIGITS);
  const PROB_ZERO_PLUS_EPILISON = "0." + repeatString("0", Hypergeometric.PMF_DIGITS - 2) + "+Îµ";
  const PROB_ROUND_TO_1_THRESHOLD = parseFloat("0." + repeatString("9", Hypergeometric.PMF_DIGITS - 1) + "5");
  const probabiltyToString = (probability) => {
    const pString = probability.toFixed(Hypergeometric.PMF_DIGITS);
    return probability === 0
      ? "0"
      : probability > PROB_ROUND_TO_1_THRESHOLD
        ? "1"
        : pString === PROB_ZERO ? PROB_ZERO_PLUS_EPILISON : pString;
  };

  const renderRows = ({rows, yMax}) => {
    //
    // Render graph
    //

    // Create and populate a data table.
    const data = new vis.DataSet();

    var counter = 0;
    for (var i = 0; i < rows.length; i+=1) {
      const {successesInPop, observedSuccesses, probability} = rows[i];
      const value = observedSuccesses/yMax;
      data.add({
        id: counter++,
        x: successesInPop,
        y: observedSuccesses,
        z: probability,
        style: value,
      });
    }
    // avoid "Graph data is not initialized" errors
    if (!rows.length) {
      data.add({
        id: counter++,
        x: 0,
        y: 0,
        z: 0,
        style: 0,
      });
    }

    if (!tempGlobal.data) {
      tempGlobal.data = data;

      // specify options
      var options = {
        width:  '1024px',
        height: '768px',
        style: 'surface',
        showPerspective: true,
        showGrid: true,
        showShadow: false,
        keepAspectRatio: true,
        verticalRatio: 0.5,
        xLabel: "success states in pop",
        yLabel: "observed successes",
      };

      // Instantiate our graph object.
      const container = document.createElement('div');
      root.appendChild(container);
      tempGlobal.graph = new vis.Graph3d(container, tempGlobal.data, options);
    } else {
      tempGlobal.data = data;
      tempGlobal.graph.setData(tempGlobal.data);
    }

    //
    // Render tables
    //

    if (!tempGlobal.tableContainer) {
      tempGlobal.tableContainer = document.createElement('div');

      root.appendChild(tempGlobal.tableContainer);
    } else {
      tempGlobal.tableContainer.innerHTML = "";
    }

    // Render individual probabilty table
    (() => {
      const individualDetails = document.createElement("details");

      const individualSummary = document.createElement("summary");
      individualSummary.textContent = "individual probabilty table";
      individualDetails.appendChild(individualSummary);

      const individualTable = document.createElement("table");

      const headerRow = document.createElement("tr");

      const successesInPopH = document.createElement("th");
      successesInPopH.textContent = "successesInPop";
      headerRow.appendChild(successesInPopH);

      const observedSuccessesH = document.createElement("th");
      observedSuccessesH.textContent = "observedSuccesses";
      headerRow.appendChild(observedSuccessesH);

      const probabilityH = document.createElement("th");
      probabilityH.textContent = "probability";
      headerRow.appendChild(probabilityH);

      individualTable.appendChild(headerRow);

      for (let i = 0; i < rows.length; i += 1) {
          const {successesInPop, observedSuccesses, probability} = rows[i];
          const dataRow = document.createElement("tr");

          const successesInPopD = document.createElement("td");
          successesInPopD.textContent = successesInPop;
          dataRow.appendChild(successesInPopD);

          const observedSuccessesD = document.createElement("td");
          observedSuccessesD.textContent = observedSuccesses;
          dataRow.appendChild(observedSuccessesD);

          const probabilityD = document.createElement("td");
          probabilityD.textContent = probabiltyToString(probability);
          dataRow.appendChild(probabilityD);

          individualTable.appendChild(dataRow);
      }

      individualDetails.appendChild(individualTable);

      tempGlobal.tableContainer.appendChild(individualDetails);
    })();

    // Render "at-least" probabilty table
    (() => {
      const atLeastDetails = document.createElement("details");

      const atLeastSummary = document.createElement("summary");
      atLeastSummary.textContent = "at-least probabilty table";
      atLeastDetails.appendChild(atLeastSummary);

      const atLeastTable = document.createElement("table");

      const headerRow = document.createElement("tr");

      const successesInPopH = document.createElement("th");
      successesInPopH.textContent = "successesInPop";
      headerRow.appendChild(successesInPopH);

      const observedSuccessesH = document.createElement("th");
      observedSuccessesH.textContent = "observedSuccesses";
      headerRow.appendChild(observedSuccessesH);

      const probabilityH = document.createElement("th");
      probabilityH.textContent = "probability";
      headerRow.appendChild(probabilityH);

      atLeastTable.appendChild(headerRow);

      const atLeastRows = []
      for (let i = 0; i < rows.length; i += 1) {
        const {successesInPop, observedSuccesses, probability} = rows[i];
        let probabilitySum = 0;
        // TODO something better than O(n^2) if/when we care
        for (let prevI = 0; prevI < rows.length; prevI += 1) {
          const other = rows[prevI];
          if (
            other.successesInPop === successesInPop
            && other.observedSuccesses >= observedSuccesses
          ) {
            probabilitySum += other.probability;
          }
        }

        atLeastRows.push({successesInPop, observedSuccesses, probability: probabilitySum});
      }

      for (let i = 0; i < atLeastRows.length; i += 1) {
          const {successesInPop, observedSuccesses, probability} = atLeastRows[i];
          const dataRow = document.createElement("tr");

          const successesInPopD = document.createElement("td");
          successesInPopD.textContent = successesInPop;
          dataRow.appendChild(successesInPopD);

          const observedSuccessesD = document.createElement("td");
          observedSuccessesD.textContent = observedSuccesses;
          dataRow.appendChild(observedSuccessesD);

          const probabilityD = document.createElement("td");
          probabilityD.textContent = probabiltyToString(probability);
          dataRow.appendChild(probabilityD);

          atLeastTable.appendChild(dataRow);
      }

      atLeastDetails.appendChild(atLeastTable);

      tempGlobal.tableContainer.appendChild(atLeastDetails);
    })();
  };

  const controls = document.createElement("form");

  const POPULATION_DEFAULT = 60;
  const populationInput = document.createElement("input");
  populationInput.type = "number";
  populationInput.id = "population-input";
  populationInput.value = POPULATION_DEFAULT;
  controls.appendChild(populationInput);

  const populationLabel = document.createElement("label");
  populationLabel.htmlFor = "population-input";
  populationLabel.innerHTML = "Population";
  controls.appendChild(populationLabel);

  const DRAWS_DEFAULT = 7;
  const drawsInput = document.createElement("input");
  drawsInput.type = "number";
  drawsInput.id = "draws-input";
  drawsInput.value = DRAWS_DEFAULT;
  controls.appendChild(drawsInput);

  const drawsLabel = document.createElement("label");
  drawsLabel.htmlFor = "draws-input";
  drawsLabel.innerHTML = "Draws";
  controls.appendChild(drawsLabel);

  const render = () => {
    var axisStep = 1;

    let popMax = parseInt(populationInput.value, 10);
    if (isNaN(popMax)) {
      popMax = POPULATION_DEFAULT;
    }

    let draws = parseInt(drawsInput.value, 10);
    if (isNaN(draws)) {
      draws = DRAWS_DEFAULT;
    }

    const rows = [];

    for (var successesInPop = 0; successesInPop <= popMax; successesInPop += axisStep) {
      for (var observedSuccesses = 0; observedSuccesses <= draws; observedSuccesses += axisStep) {
        if (observedSuccesses > popMax || observedSuccesses > successesInPop) { continue }

        const probability = Hypergeometric.pmf(popMax, successesInPop, draws, observedSuccesses);
        rows.push({successesInPop, observedSuccesses, probability});
      }
    }

    renderRows({rows, yMax: draws});
  };

  controls.addEventListener("change", render);

  root.appendChild(controls);

  render();
</script>

</html>
